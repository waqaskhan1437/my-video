name: Archive to PostForMe Multi Automation

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: "run = process automation profiles, list_accounts = show connected PostForMe accounts"
        required: false
        type: choice
        default: "run"
        options:
          - "run"
          - "list_accounts"
      automation_id:
        description: "Optional single automation ID from automations/postforme_automations.json"
        required: false
        default: ""
      window_mode:
        description: "Override source window mode for this run"
        required: false
        type: choice
        default: "automation"
        options:
          - "automation"
          - "new_since_last_run"
          - "last_x_days"
          - "specific_date"
          - "all"
      last_x_days:
        description: "Used when window_mode=last_x_days (example: 7)"
        required: false
        default: ""
      specific_date:
        description: "Used when window_mode=specific_date (YYYY-MM-DD)"
        required: false
        default: ""
      max_items_override:
        description: "Optional max items override for selected automation(s)"
        required: false
        default: ""
      archive_prefix_override:
        description: "Optional archive prefix override (example: gp_)"
        required: false
        default: ""
      dry_run:
        description: "true = no real social-post creation"
        required: false
        type: choice
        default: "false"
        options:
          - "false"
          - "true"
  schedule:
    - cron: "35 3 * * *"

permissions:
  contents: write

concurrency:
  group: archive-postforme-daily
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          pip install requests yt-dlp

      - name: Validate secrets
        env:
          POSTFORME_API_KEY: ${{ secrets.POSTFORME_API_KEY }}
        run: |
          if [ -z "${POSTFORME_API_KEY}" ]; then
            echo "Missing POSTFORME_API_KEY"
            exit 1
          fi

      - name: Run archive -> postforme automation
        env:
          POSTFORME_API_KEY: ${{ secrets.POSTFORME_API_KEY }}
          POSTFORME_BASE_URL: https://api.postforme.dev/v1
          AUTOMATIONS_CONFIG_PATH: automations/postforme_automations.json
          RUN_MODE: ${{ inputs.run_mode || 'run' }}
          AUTOMATION_ID: ${{ inputs.automation_id || '' }}
          WINDOW_MODE_OVERRIDE: ${{ inputs.window_mode || 'automation' }}
          LAST_X_DAYS_OVERRIDE: ${{ inputs.last_x_days || '' }}
          SPECIFIC_DATE_OVERRIDE: ${{ inputs.specific_date || '' }}
          MAX_ITEMS_OVERRIDE: ${{ inputs.max_items_override || '' }}
          ARCHIVE_PREFIX_OVERRIDE: ${{ inputs.archive_prefix_override || '' }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: python scripts/archive_to_postforme.py

      - name: Commit postforme state
        run: |
          touch postforme_state.json
          if [ -z "$(git status --porcelain -- postforme_state.json)" ]; then
            echo "No postforme state changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add postforme_state.json
          git commit -m "chore: update postforme automation state"
          git push

